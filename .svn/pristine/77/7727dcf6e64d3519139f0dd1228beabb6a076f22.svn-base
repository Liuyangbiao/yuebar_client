package com.fullteem.yueba.app.ui;

import java.io.File;
import java.util.LinkedList;
import java.util.List;

import org.robobinding.ViewBinder;
import org.robobinding.binder.BinderFactory;
import org.robobinding.binder.BinderFactoryBuilder;

import android.content.ContentResolver;
import android.content.Intent;
import android.database.Cursor;
import android.graphics.Bitmap;
import android.graphics.Color;
import android.net.Uri;
import android.os.Bundle;
import android.os.Handler;
import android.os.Message;
import android.provider.MediaStore;
import android.support.v7.widget.LinearLayoutManager;
import android.support.v7.widget.RecyclerView;
import android.text.TextUtils;
import android.util.Log;
import android.view.View;
import android.view.View.OnClickListener;
import android.widget.Button;
import android.widget.ImageView;

import com.fullteem.yueba.R;
import com.fullteem.yueba.app.AppContext;
import com.fullteem.yueba.app.adapter.GroupMembersAdapter;
import com.fullteem.yueba.app.adapter.PerssonalAlbumAdapter;
import com.fullteem.yueba.db.DBGroupsDao;
import com.fullteem.yueba.model.GiftModel;
import com.fullteem.yueba.model.Group;
import com.fullteem.yueba.model.PicModle;
import com.fullteem.yueba.model.ResponeModel;
import com.fullteem.yueba.model.UploadModel;
import com.fullteem.yueba.model.presentmodel.GroupDeatilPresentModel;
import com.fullteem.yueba.net.http.CustomAsyncResponehandler;
import com.fullteem.yueba.net.http.HttpRequest;
import com.fullteem.yueba.net.http.HttpRequestFactory;
import com.fullteem.yueba.util.CuttingPicturesUtil;
import com.fullteem.yueba.util.DisplayUtils;
import com.fullteem.yueba.util.ImageLoaderUtil;
import com.fullteem.yueba.util.JsonUtil;
import com.fullteem.yueba.util.LogUtil;
import com.fullteem.yueba.widget.TopTitleView;

/**
 * @author jun
 * @version 1.0.0
 * @created 2015年1月12日&emsp;上午9:28:40
 * @use 群组详细资料
 */
public class GroupDetailActivity extends BaseActivity {
	private GroupDeatilPresentModel presentMode;
	private RecyclerView recyclerviewAlbum, recyclerviewMembers;
	private Button btnSureJoin;// 申请加入
	private PerssonalAlbumAdapter adapterAlbum;
	private GroupMembersAdapter adapterMembers;
	private List<GiftModel> listAlbumUrl;
	private List<PicModle> listMembers;
	private List<String> listUpImgUrls;
	private String groupId;
	private EventListener mListener;
	private boolean isEdit;// 是否在编辑群资料

	private UploadModel upModel;

	private final int GROUP_PHOTO = 0xFF9900; // 群组相册集
	private List<String> listLocalImg;// 本地图片

	private enum BtnTag {
		TAG_NORMAL, // 默认情况
		TAG_JOINED, // 已加入该群
		TAG_MANAGE, // 群主
	}

	public GroupDetailActivity() {
		super(-1);
	}

	@Override
	protected void onCreate(Bundle savedInstanceState) {
		BinderFactory binderFactory = new BinderFactoryBuilder().build();
		ViewBinder vb = binderFactory.createViewBinder(this, true);
		presentMode = new GroupDeatilPresentModel(GroupDetailActivity.this);
		View rootView = vb.inflateAndBind(R.layout.activity_group_detail,
				presentMode);
		setContentView(rootView);
		super.onCreate(savedInstanceState);
	}

	@Override
	public void initViews() {
		initTopTitle();
		recyclerviewAlbum = (RecyclerView) findViewById(R.id.recyclerview_album);
		recyclerviewMembers = (RecyclerView) findViewById(R.id.recyclerview_members);
		btnSureJoin = (Button) findViewById(R.id.btn_sureJoin);
		btnSureJoin.setTag(BtnTag.TAG_NORMAL);
		btnSureJoin.setVisibility(View.INVISIBLE);
	}

	private void initTopTitle() {
		TopTitleView topTitle = (TopTitleView) findViewById(R.id.top_title);
		topTitle.showLeftImag(R.drawable.back, new OnClickListener() {
			@Override
			public void onClick(View v) {
				finish();
			}
		});
		topTitle.showCenterText(getString(R.string.discover_nearbyGroup), null);
	}

	@Override
	public void initData() {
		groupId = getIntent().getStringExtra("GROUP_ID");
		mListener = new EventListener();

		LinearLayoutManager[] layoutManager = new LinearLayoutManager[2];
		for (int i = 0; i < layoutManager.length; i++) {
			layoutManager[i] = new LinearLayoutManager(this);
			layoutManager[i].setOrientation(LinearLayoutManager.HORIZONTAL);
		}
		recyclerviewAlbum.setLayoutManager(layoutManager[0]);
		recyclerviewMembers.setLayoutManager(layoutManager[1]);

		recyclerviewAlbum
				.setAdapter(adapterAlbum = adapterAlbum == null ? new PerssonalAlbumAdapter(
						listAlbumUrl = listAlbumUrl == null ? new LinkedList<GiftModel>()
								: listAlbumUrl)
						: adapterAlbum);
		recyclerviewMembers
				.setAdapter(adapterMembers = adapterMembers == null ? new GroupMembersAdapter(
						listMembers = listMembers == null ? new LinkedList<PicModle>()
								: listMembers)
						: adapterMembers);
		loadDate();
	}

	@Override
	public void bindViews() {
		btnSureJoin.setOnClickListener(mListener);
	}

	private class EventListener implements OnClickListener {
		@Override
		public void onClick(View v) {
			if (v == btnSureJoin) {
				if (btnSureJoin.getTag() == null)
					return;
				if (btnSureJoin.getTag() == BtnTag.TAG_NORMAL) {
					joinGroup();
					return;
				}
				if (btnSureJoin.getTag() == BtnTag.TAG_JOINED) {
					outGroup();
					return;
				}
				if (btnSureJoin.getTag() == BtnTag.TAG_MANAGE) {
					if (isEdit) {
						UpdateGroupIntroduction();
						if (listAlbumUrl.size() > 0
								&& "add".equals(listAlbumUrl.get(
										listAlbumUrl.size() - 1).getTypeTag())) {
							listAlbumUrl.remove(listAlbumUrl.size() - 1);
							adapterAlbum
									.notifyItemChanged(listAlbumUrl.size() - 1);
						}
						if (listLocalImg != null && listLocalImg.size() > 0) {
							for (String str : listLocalImg)
								upLoadPic(str);
						}
					} else {
						isEdit = true;
						btnSureJoin.setText("保存");
						addPictures(listAlbumUrl, null);
						adapterAlbum
								.notifyItemChanged((listAlbumUrl.size() - 1) > 0 ? listAlbumUrl
										.size() - 1 : 0);
						findViewById(R.id.etGroupIntroduction).setEnabled(true);
					}
					if (listAlbumUrl.size() <= 0)
						presentMode.setAlbumVisibility(View.GONE);
					else
						presentMode.setAlbumVisibility(View.VISIBLE);
					return;
				}
			}

		}
	}

	/**
	 * 加载群信息
	 */
	private void loadDate() {
		Integer userId = Integer.valueOf(AppContext.getApplication()
				.getUserInfo().getUserId());
		if (userId == null || userId == -1 || TextUtils.isEmpty(groupId))
			return;
		HttpRequest.getInstance().getGroupDetail(userId, groupId,
				new CustomAsyncResponehandler() {

					@Override
					public void onSuccess(ResponeModel baseModel) {
						if (baseModel == null || !baseModel.isStatus()) {
							showToast(getString(R.string.hint_groupError));
							return;
						}
						// 群成员
						List<PicModle> listResultPic = (List<PicModle>) baseModel
								.getListObject("userLogoUrlList",
										PicModle.class);
						if (listResultPic != null && listResultPic.size() > 0
								&& listResultPic.get(0) != null) {
							presentMode.setMembersVisibility(View.VISIBLE);
							if (listMembers.size() > 0)
								listMembers.clear();
							listMembers.addAll(listResultPic);
							adapterMembers.notifyItemRangeInserted(0,
									listMembers.size());
						}
						// 群图片
						List<GiftModel> listResultAlbum = (List<GiftModel>) baseModel
								.getListObject("userGroupImgUrlList",
										GiftModel.class);
						if (listResultAlbum != null
								&& listResultAlbum.size() > 0
								&& listResultAlbum.get(0) != null) {
							presentMode.setAlbumVisibility(View.VISIBLE);
							if (listAlbumUrl.size() > 0)
								listAlbumUrl.clear();
							listAlbumUrl.addAll(listResultAlbum);
							adapterAlbum.notifyDataSetChanged();
						}
						// 群信息
						btnSureJoin.setVisibility(View.VISIBLE);
						Group groupModel = (Group) baseModel.getObject(
								"barGroupList", Group.class);
						if (groupModel != null) {
							presentMode.setModel(groupModel);
							if (groupModel.isInGroup()) {
								btnSureJoin.setText("退出该群");
								btnSureJoin.setTag(BtnTag.TAG_JOINED);
							} else {
								btnSureJoin.setText("申请加入");
								btnSureJoin.setTag(BtnTag.TAG_NORMAL);
							}
							if (!TextUtils.isEmpty(groupModel.getGroupIcon())) {
								ImageView ivGroupHeader = (ImageView) findViewById(R.id.ivGroupHeader);
								ivGroupHeader
										.setBackgroundColor(Color.TRANSPARENT);
								ImageLoaderUtil
										.getImageLoader()
										.displayImage(
												DisplayUtils
														.getAbsolutelyUrl(groupModel
																.getGroupIcon()),
												ivGroupHeader,
												ImageLoaderUtil
														.getOptions(
																R.drawable.img_loading_default_copy,
																R.drawable.img_loading_empty_copy,
																R.drawable.img_loading_fail_copy));
							}

							if (!TextUtils.isEmpty(groupModel
									.getHarmastLogoUrl())) {
								ImageView ivHarmastHeader = (ImageView) findViewById(R.id.ivHarmastHeader);
								ImageLoaderUtil.getImageLoader().displayImage(
										DisplayUtils
												.getAbsolutelyUrl(groupModel
														.getHarmastLogoUrl()),
										ivHarmastHeader,
										ImageLoaderUtil.getOptions());
							}
							// TODO 如果群主id和当前用户一样，则可编辑
							Integer currentUserId = Integer
									.valueOf(AppContext.getApplication()
											.getUserInfo().getUserId());
							if (currentUserId != null)
								if (groupModel.getUserId() == currentUserId) {
									btnSureJoin.setText("管理群组");
									btnSureJoin.setTag(BtnTag.TAG_MANAGE);
									if (isEdit)
										isEdit = !isEdit;
								}

							// 将群信息插入数据库(直接存)
							DBGroupsDao dao = new DBGroupsDao(context);
							Group group = new Group();
							group.setGroupIcon(groupModel.getGroupIcon());
							group.setGroupId(groupModel.getGroupId());
							group.setGroupName(groupModel.getGroupName());
							dao.saveGroup(group);

						}
					}

					@Override
					public void onFailure(Throwable error, String content) {
						LogUtil.LogDebug(null, "群组详细信息" + error.toString()
								+ "\n" + content, null);
						showToast(getString(R.string.hint_groupError));
					}
				});
	}

	/**
	 * 加入群组
	 */
	private void joinGroup() {
		String userMobile = AppContext.getApplication().getUserInfo()
				.getUserMobile();
		if (TextUtils.isEmpty(userMobile) || TextUtils.isEmpty(groupId))
			return;
		HttpRequest.getInstance(GroupDetailActivity.this).getJoinGroup(
				userMobile, groupId, new CustomAsyncResponehandler() {

					@Override
					public void onSuccess(ResponeModel baseModel) {
						if (baseModel != null && baseModel.isStatus()) {
							loadDate();
							return;
						}
						showToast(getString(R.string.hint_operationError));
					}

					@Override
					public void onFailure(Throwable error, String content) {
						showToast(getString(R.string.hint_operationError));
					}
				});
	}

	/**
	 * 退出群组
	 */
	private void outGroup() {
		String userMobile = AppContext.getApplication().getUserInfo()
				.getUserMobile();
		if (TextUtils.isEmpty(userMobile) || TextUtils.isEmpty(groupId))
			return;
		HttpRequest.getInstance(GroupDetailActivity.this).getOutGroup(
				userMobile, groupId, new CustomAsyncResponehandler() {

					@Override
					public void onSuccess(ResponeModel baseModel) {
						if (baseModel != null && baseModel.isStatus()) {
							loadDate();
							return;
						}
						showToast(getString(R.string.hint_operationError));
					}

					@Override
					public void onFailure(Throwable error, String content) {
						showToast(getString(R.string.hint_operationError));
					}
				});
	}

	/**
	 * 更新群简介
	 */
	private void UpdateGroupIntroduction() {
		if (TextUtils.isEmpty(groupId)) {
			showToast(getString(R.string.hint_operationError));
			return;
		}
		if (TextUtils.isEmpty(presentMode.getGroupIntroduction())) {
			showToast(getString(R.string.hint_inputIntroduction));
			return;
		}
		HttpRequest.getInstance(GroupDetailActivity.this)
				.getUpdateGroupIntroduction(groupId,
						presentMode.getGroupIntroduction(),
						new CustomAsyncResponehandler() {

							@Override
							public void onSuccess(ResponeModel baseModel) {
								if (baseModel != null && baseModel.isStatus()) {
									if (listLocalImg == null
											|| listLocalImg.size() <= 0)
										loadDate();
									findViewById(R.id.etGroupIntroduction)
											.setEnabled(false);
									return;
								}
								showToast(getString(R.string.hint_operationError));
							}

							@Override
							public void onFailure(Throwable error,
									String content) {
								showToast(getString(R.string.hint_operationError));
							}
						});
	}

	/**
	 * 添加相册相片的方法
	 * 
	 * @param giftList
	 * @param picUrl
	 *            初始时为null则添加"add"
	 * @return
	 */
	private List<GiftModel> addPictures(List<GiftModel> giftList, String picUrl) {
		if (giftList.size() > 0
				&& "add".equals(giftList.get(giftList.size() - 1).getTypeTag()))
			giftList.remove(giftList.size() - 1);
		if (!TextUtils.isEmpty(picUrl)) {
			GiftModel gm = new GiftModel();
			gm.setGiftLogoUrl("file://" + picUrl);
			giftList.add(gm);
		}
		// 最多展示八张图
		if (giftList.size() < 8) {
			// 添加最后一张图为添加按钮
			GiftModel gm1 = new GiftModel();
			gm1.setTypeTag("add");
			giftList.add(gm1);
		}
		return giftList;
	}

	@Override
	protected void onActivityResult(int requestCode, int resultCode, Intent data) {
		if (data == null)
			return;
		switch (requestCode) {
		case CuttingPicturesUtil.UPLOAD_PIC:
			System.out.println(data.getData());
			Uri originalUri = data.getData();
			ContentResolver cr = this.getContentResolver();
			Bitmap bm = null;
			try {
				// Bitmap bitmap = BitmapFactory.decodeStream(cr
				// .openInputStream(uri));
				// /* 将Bitmap设定到ImageView */
				// imageView.setImageBitmap(bitmap);
				// addPictures(listAlbumUrl, uri);
				bm = MediaStore.Images.Media.getBitmap(cr, originalUri); // 显得到bitmap图片
				String[] proj = { MediaStore.Images.Media.DATA };
				// 好像是android多媒体数据库的封装接口，具体的看Android文档
				Cursor cursor = managedQuery(originalUri, proj, null, null,
						null);
				// 获得用户选择的图片的索引值
				int column_index = cursor
						.getColumnIndexOrThrow(MediaStore.Images.Media.DATA);
				// 将光标移至开头 ，这个很重要，不小心很容易引起越界
				cursor.moveToFirst();
				// 最后根据索引值获取图片路径
				String path = cursor.getString(column_index);
				System.out.println(path);
				addPictures(listAlbumUrl, path);
				if (listLocalImg == null)
					listLocalImg = new LinkedList<String>();
				listLocalImg.add(path);
			} catch (Exception e) {
				Log.e("Exception", e.getMessage(), e);
			}
			adapterAlbum.notifyDataSetChanged();
			break;
		}
	}

	/**
	 * 上传图片
	 */
	public void upLoadPic(String path) {
		System.out.println("上传图片" + path);
		File file = new File(path);
		HttpRequestFactory.getInstance(GroupDetailActivity.this).uploadFile(
				GroupDetailActivity.this, file,
				new CustomAsyncResponehandler() {

					@Override
					public void onStart() {
					}

					@Override
					public void onSuccess(String content) {
						super.onSuccess(content);
					}

					@Override
					public void onFailure(Throwable error, String content) {
					}

					@Override
					public void onFinish() {
					}

					@Override
					public void onSuccess(ResponeModel baseModel) {
						upModel = new UploadModel();
						upModel = JsonUtil.convertJsonToObject(
								baseModel.getJson(), UploadModel.class);
						if (!TextUtils.isEmpty(upModel.getResult()))
							uploadHandler.obtainMessage(GROUP_PHOTO, upModel)
									.sendToTarget();
					}

				});
	}

	/**
	 * 上传结束后的handler处理事件
	 */
	private Handler uploadHandler = new Handler() {
		public void handleMessage(Message msg) {
			if (msg.what == GROUP_PHOTO) {
				upModel = (UploadModel) msg.obj;
				if (listUpImgUrls == null)
					listUpImgUrls = new LinkedList<String>();
				listUpImgUrls.add(upModel.getResult());
				if (listUpImgUrls.size() < listLocalImg.size())
					return;
				// 说明上传图片完毕
				String urls = null;
				if (listAlbumUrl != null && listAlbumUrl.size() > 0)
					for (GiftModel gm : listAlbumUrl) {
						if (TextUtils.isEmpty(gm.getGiftLogoUrl())
								|| gm.getGiftLogoUrl().contains("file://")
								|| gm.getGiftLogoUrl().contains("drawable://"))
							continue;
						urls = urls == null ? gm.getGiftLogoUrl() : urls + ","
								+ gm.getGiftLogoUrl();
					}
				for (int i = 0; i < listUpImgUrls.size(); i++)
					urls = urls == null ? listUpImgUrls.get(i) : urls + ","
							+ listUpImgUrls.get(i);
				setGroupPhoto(urls);
				listLocalImg.clear();
				listUpImgUrls.clear();
				return;
			}
		}
	};

	/**
	 * 设置群组相册
	 */
	private void setGroupPhoto(String imgUrls) {
		if (TextUtils.isEmpty(groupId)) {
			showToast(getString(R.string.hint_operationError));
			return;
		}
		HttpRequest.getInstance(GroupDetailActivity.this).getGroupUpPhoto(
				groupId, imgUrls, new CustomAsyncResponehandler() {

					@Override
					public void onSuccess(ResponeModel baseModel) {
						if (baseModel != null && baseModel.isStatus())
							loadDate();
					}

					@Override
					public void onFailure(Throwable error, String content) {
						showToast("图片上传失败");
					}
				});
	}

}
